# Message Utils - Утилиты для работы с сообщениями

## Описание

Модуль `message_utils.py` содержит универсальные функции для умной работы с сообщениями в админ панели, которые решают проблему засорения чата множественными сообщениями.

## Основные функции

### `edit_message(query, text, reply_markup=None, parse_mode="HTML", bot=None)`

**ГЛАВНАЯ** универсальная функция для редактирования сообщений:

**Логика работы:**
1. **Автоматическое определение типа** - проверяет наличие медиа в сообщении
2. **Текстовые сообщения** - пытается редактировать, при ошибке удаляет и отправляет новое
3. **Медиа-сообщения** - удаляет старое и отправляет новое текстовое
4. **Устойчивость к ошибкам** - множественные fallback стратегии
5. **Подробное логирование** - отслеживание всех операций

**Преимущества:**
- ✅ Избегает засорения чата
- ✅ Корректно обрабатывает все типы сообщений
- ✅ Устойчив к ошибкам с fallback стратегиями
- ✅ Автоматически выбирает оптимальную стратегию
- ✅ Подробное логирование для отладки

### `send_message(bot, chat_id, text="", reply_markup=None, parse_mode="HTML", **kwargs)`

Универсальная функция для отправки сообщений с поддержкой медиа:

**Логика работы:**
1. **Автоматическое определение типа медиа** - по переданным параметрам
2. **Поддержка всех типов медиа** - фото, видео, документы
3. **Fallback на текстовое сообщение** - при ошибках
4. **Устойчивость к ошибкам** - с подробным логированием

## Функции обратной совместимости

### `smart_edit_message()`, `safe_edit_message()`, `universal_edit_message()`

Все эти функции теперь являются алиасами для `edit_message()` и сохраняются для обратной совместимости.

### `send_or_edit_message(bot, chat_id, message_id=None, text="", reply_markup=None, parse_mode="HTML", **kwargs)`

Универсальная функция для отправки или редактирования сообщений с поддержкой медиа.

### `cleanup_old_messages(bot, chat_id, message_ids)`

Утилита для массового удаления старых сообщений.

## Использование

### Базовое использование

```python
from .message_utils import smart_edit_message

# В обработчике callback query
await smart_edit_message(query, "Новый текст", keyboard, "HTML", bot)
```

### Обратная совместимость

```python
from .message_utils import safe_edit_message

# Старый код продолжает работать
await safe_edit_message(query, "Текст", keyboard, "HTML", bot)
```

## Решенные проблемы

1. **Медиа в меню** - медиа больше не остается видимым во всех вкладках меню
2. **Засорение чата** - минимизируется количество сообщений в чате
3. **Ошибки редактирования** - автоматическая обработка ошибок с fallback стратегией
4. **Универсальность** - одно решение для всех сценариев

## Будущие улучшения

- Поддержка batch операций
- Кэширование состояний сообщений
- Метрики производительности
- Расширенная обработка медиа-типов
